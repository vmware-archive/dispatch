---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: dispatchframework/concourse-dcind

inputs:
- name: dispatch
- name: dispatch-binaries

outputs:
- name: tests-logs

run:
  path: entrypoint.sh
  args:
  - bash
  - -ceux
  - |

    export DOCKER_REGISTRY=dispatchframework
    export INSTALL_DISPATCH=0
    export INGRESS_PORT=80
    export CI=true
    export TERM=linux
    export DISPATCH_ORGANIZATION=ci-org

    cp dispatch-binaries/dispatch-linux /usr/local/bin/dispatch
    mkdir -p ~/.dispatch

    export API_GATEWAY_HTTP_PORT=9090
    export API_GATEWAY_HTTPS_PORT=9090 #TODO: update this when we support certs
    echo "127.0.0.1 dispatch.local api.dispatch.local" >> /etc/hosts
    export API_GATEWAY_HTTPS_HOST="http://api.dispatch.local:${API_GATEWAY_HTTP_PORT}" #TODO: update this when we support certs
    export API_GATEWAY_HTTP_HOST="http://api.dispatch.local:${API_GATEWAY_HTTP_PORT}"
    cp dispatch/ci/e2e/configs/dispatch-config-local.json ~/.dispatch/config.json
    sed -i "s/INGRESS_PORT/$INGRESS_PORT/g" ~/.dispatch/config.json

    cp dispatch-binaries/dispatch-server-linux /usr/local/bin/dispatch-server

    dispatch-server --host 0.0.0.0 --port $INGRESS_PORT --gateway-port $API_GATEWAY_HTTP_PORT --api-endpoint 172.17.0.1:$INGRESS_PORT --debug > $(pwd)/tests-logs/server.log 2>&1 &

    sleep 5

    export BATS_LOG="$(pwd)/tests-logs/bats.log"
    pushd dispatch
    ./e2e/scripts/run-e2e.sh e2e/tests
