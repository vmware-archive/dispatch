---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: vmware/dispatch-k8s-ci
    tag: v0.0.10

params:
  GKE_KEY:
  GKE_PROJECT_ID:

# dispatch must be dispatch git repo.
# dispatch-cli must contain "dispatch" binary
inputs:
- name: dispatch
- name: cluster
- name: dispatch-cli

outputs:
- name: tests-logs

run:
  path: /bin/bash
  args:
  - -c
  - |
    set -e -x -u

    source dispatch/ci/e2e/config-k8s-env.sh
    export INSTALL_DISPATCH=0
    export CI=true
    export TERM=linux

    cp dispatch-cli/dispatch /usr/local/bin/dispatch
    mkdir -p ~/.dispatch

    if [[ -n ${GKE_PROJECT_ID} ]]; then
      export LOADBALANCER_IP=$(kubectl get svc/ingress-nginx-ingress-controller -n kube-system -o json | jq -r '.status.loadBalancer.ingress[0].ip')
      export API_GATEWAY_IP=$(kubectl get svc/api-gateway-kongproxy -n kong -o json | jq -r '.status.loadBalancer.ingress[0].ip')
      cp dispatch/ci/e2e/configs/dispatch-config-gke.json ~/.dispatch/config.json
      sed -i "s/LOADBALANCER_IP/$LOADBALANCER_IP/g" ~/.dispatch/config.json

      export API_GATEWAY_HTTPS_HOST="https://${API_GATEWAY_IP}:443"
      export API_GATEWAY_HTTP_HOST="http://${API_GATEWAY_IP}:80"

    else
      export INGRESS_PORT=$(kubectl get svc/ingress-nginx-ingress-controller -n kube-system -o json | jq -r '.spec.ports[1].nodePort')
      export NODE_IP=$(cat cluster/metadata | jq -r '.nodeIP')
      export API_GATEWAY_HTTP_PORT=$(kubectl get svc/api-gateway-kongproxy -n kong -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}')
      export API_GATEWAY_HTTPS_PORT=$(kubectl get svc/api-gateway-kongproxy -n kong -o jsonpath='{.spec.ports[?(@.port==443)].nodePort}')
      echo "${NODE_IP} dispatch.local dev.dispatch.local" >> /etc/hosts
      export API_GATEWAY_HTTPS_HOST="https://api.dispatch.local:${API_GATEWAY_HTTPS_PORT}"
      export API_GATEWAY_HTTP_HOST="http://api.dispatch.local:${API_GATEWAY_HTTPS_PORT}"
      cp dispatch/ci/e2e/configs/dispatch-config-local.json ~/.dispatch/config.json
      sed -i "s/INGRESS_PORT/$INGRESS_PORT/g" ~/.dispatch/config.json
    fi
    export BATS_LOG="$(pwd)/tests-logs/bats.log"
    pushd dispatch
    set +e
    ./e2e/scripts/run-e2e.sh e2e/tests
    test_result=$?
    popd
    set -e
    if [ "$test_result" -eq 0 ]
    then
        set +x
        if [[ -n ${GKE_PROJECT_ID} ]]; then
            cp dispatch/ci/e2e/configs/dispatch-install-gke.yml install.yaml
        else
            cp dispatch/ci/e2e/configs/dispatch-install-local.yml install.yaml
        fi
        set -x
        dispatch uninstall --file install.yaml
        exit $?
    else
        # collect logs must uninstall
        exit 1
    fi

